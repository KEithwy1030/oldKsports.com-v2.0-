# 生产环境问题诊断报告

## 测试时间
2025-01-11

## 测试环境
- 生产环境URL: https://oldksports.zeabur.app/
- 测试账号: 552319164@qq.com (管理员)
- 测试页面: 论坛页面、个人中心页面

---

## 问题汇总

### ❌ 问题1: `/api/users/online/today` 接口返回500错误

**影响页面**: 论坛页面 (`/forum`)

**错误信息**:
```
❌ 加载今日在线用户失败: Error: Failed to get online users
API Error: 500
```

**可能原因**:
1. SQL查询中使用了 `role` 字段，但该字段在生产环境数据库中可能不存在或数据结构不一致
2. `TIMESTAMPDIFF` 函数可能在某些MySQL版本中不兼容
3. `roles` JSON字段解析问题（虽然已经添加了 `normalizeRoles` 函数，但可能在查询阶段就失败了）
4. 数据库连接或查询执行失败

**代码位置**:
- `server/controllers/user.controller.js:326-405`
- 查询语句包含 `role` 和 `roles` 字段

**影响**:
- 论坛页面右侧"当前在线"区域显示"暂无在线用户"
- 无法查看今日在线用户列表

---

### ❌ 问题2: `/api/user-stats/me` 接口返回500错误

**影响页面**: 个人中心页面 (`/profile`)

**错误信息**:
```
GET https://oldksports-api.zeabur.app/api/user-stats/me 500 (Internal Server Error)
```

**可能原因**:
1. `getUserStats` 方法使用了 `getDb().execute()` 而不是 `getDb().query()`，可能导致兼容性问题
2. 查询的字段 (`total_posts`, `total_replies`, `consecutive_checkins`, `last_checkin_date`) 在生产环境数据库中可能不存在
3. 数据库表结构与开发环境不一致

**代码位置**:
- `server/services/userStats.service.js:83-116`
- `server/controllers/userStats.controller.js:4-20`

**影响**:
- 个人中心页面无法显示用户统计数据（发帖数量、回复数量、连续签到天数）
- 统计数据区域显示为0或默认值

---

### ❌ 问题3: `/api/merchants` 接口返回500错误

**影响页面**: 论坛页面、首页

**错误信息**:
```
加载商家失败: HTTP 500
```

**可能原因**:
1. 商家数据查询失败
2. 数据库表结构问题
3. 权限或认证问题

**影响**:
- 首页和论坛页面无法显示"诚信商家"列表
- 商家信息显示为"暂无商家信息"

---

## 问题分析

### 核心问题
所有问题都指向**数据库表结构与代码不匹配**的可能性：

1. **字段缺失**: 生产环境数据库可能缺少某些字段（如 `role`, `total_posts`, `total_replies` 等）
2. **数据迁移不完整**: 从旧版本迁移数据时，可能没有正确创建或更新表结构
3. **MySQL版本差异**: 开发环境和生产环境的MySQL版本可能不同，导致某些SQL语法不兼容

### 开发环境 vs 生产环境差异

**开发环境**:
- 可能使用本地MySQL或Docker容器
- 表结构通过 `database_init_schema.sql` 初始化
- 数据可能是手动插入的测试数据

**生产环境**:
- 使用Zeabur云服务MySQL
- 表结构可能来自旧版本迁移
- 数据来自真实的1.0版本数据导入

---

## 建议修复方案

### 1. 数据库表结构检查
- 检查生产环境数据库中 `users` 表的实际字段
- 确认是否存在以下字段：
  - `role` (VARCHAR)
  - `total_posts` (INT)
  - `total_replies` (INT)
  - `consecutive_checkins` (INT)
  - `last_checkin_date` (DATE)
  - `roles` (JSON)

### 2. 修复 `getTodayOnlineUsers` 接口
- 如果 `role` 字段不存在，从查询中移除
- 确保 `roles` 字段查询和解析正确
- 添加更详细的错误日志

### 3. 修复 `getUserStats` 接口
- 如果统计字段不存在，创建这些字段或使用替代查询方式
- 统一使用 `getDb().query()` 而不是 `getDb().execute()`
- 添加字段存在性检查

### 4. 修复商家接口
- 检查商家表结构和查询逻辑
- 确认商家数据是否正确导入

---

## 优先级

1. **高优先级**: 问题1（在线用户）和问题2（用户统计）
   - 影响用户体验的核心功能
   - 需要尽快修复

2. **中优先级**: 问题3（商家列表）
   - 影响内容展示，但不影响核心功能

---

## 下一步行动

1. 连接生产环境数据库，检查实际表结构
2. 根据实际表结构修复代码
3. 添加字段存在性检查和容错处理
4. 测试修复后的接口
5. 部署到生产环境

