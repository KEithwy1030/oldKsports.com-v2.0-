FROM node:22-slim

LABEL "language"="nodejs"
LABEL "framework"="express"

WORKDIR /app

# 安装后端依赖（优化：移除已弃用的 --only=production 标志）
COPY server/package*.json ./
RUN npm ci --omit=dev

# 复制数据库初始化脚本（供自动迁移脚本使用）
COPY database_init_schema.sql ../

# 复制后端代码
COPY server/ ./

# 创建上传目录（确保目录存在，避免运行时创建失败）
RUN mkdir -p ./uploads/images && mkdir -p ./public/uploads/images

EXPOSE 8080

CMD ["npm", "start"]

